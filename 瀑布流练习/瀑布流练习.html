<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        *{
            padding: 0;
            margin: 0;
        }
        #main{
            position: relative;
        }
        .box{
            float: left;
            padding: 10px 0 0 10px;
        }
        .pic{
            border: 1px solid #CCCCCC;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 0 10px #ddd;
        }
        img{
            width: 150px;;
        }
    </style>
</head>
<body>
<div id="main">
    <div class="box">
        <div class="pic">
            <img src="images/0.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/1.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/2.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/3.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/4.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/5.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/6.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/7.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/8.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/9.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/10.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/11.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/12.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/13.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/14.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/15.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/16.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/17.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/18.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/19.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/20.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/21.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/22.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/23.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/24.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/25.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/26.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/27.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/28.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/29.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/30.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/31.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/32.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/33.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/34.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/35.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/36.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/37.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/38.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/39.jpg" alt="">
        </div>
    </div>
    <div class="box">
        <div class="pic">
            <img src="images/40.jpg" alt="">
        </div>
    </div>

</div>



<script src="js/MyFunc.js"></script>
<script src="js/Underscore-min.js"></script>
<script>
    /****
     * 1.让整个父盒子在页面进行水平居中(在不同屏幕下)
     *
     * 2.除了第一行盒子其余行的盒子都需要相对父盒子做一个定位
     *
     *
     * 3.判断什么时候加载更多的盒子(源源不断)
     *
     * 4.当满足第三步的条件,需要加载数据(造数据)
     *
     * ***/
    window.onload=function(){
        waterFlow("main","box");


        window.onscroll=function(){
            if(isWillLoadBox()){
               var imgArr=[{src: '0.jpg'}, {src: '1.jpg'}, {src: '2.jpg'}, {src: '3.jpg'}, {src: '4.jpg'}, {src: '5.jpg'}, {src: '6.jpg'}, {src: '7.jpg'}, {src: '8.jpg'}, {src: '9.jpg'},{src: '10.jpg'}, {src: '11.jpg'}, {src: '12.jpg'}, {src: '13.jpg'}, {src: '14.jpg'}, {src: '15.jpg'}, {src: '16.jpg'}, {src: '17.jpg'}, {src: '18.jpg'}, {src: '19.jpg'},{src: '20.jpg'}, {src: '21.jpg'}, {src: '22.jpg'}, {src: '23.jpg'}, {src: '24.jpg'}, {src: '25.jpg'}, {src: '26.jpg'}, {src: '27.jpg'}, {src: '28.jpg'}, {src: '29.jpg'}]

                for(var i=0;i<imgArr.length;i++){
                    var newbox=document.createElement("div");
                    newbox.className="box";
                    $("main").appendChild(newbox);

                    var newpic=document.createElement("div");
                    newpic.className="pic";
                    newbox.appendChild(newpic);

                    var newimg=document.createElement("img");
                    newimg.src="images/"+imgArr[i].src;
                    newpic.appendChild(newimg);
                }
                waterFlow("main","box");

            }
        }



    };



    function waterFlow(parent,box){
        var allBox=$(parent).getElementsByClassName(box);
        var boxWidth=allBox[0].offsetWidth;
        var screenW=document.documentElement.clientWidth||document.body.clientWidth;
        var cols=Math.floor(screenW/boxWidth);
        var parentW=cols*boxWidth;
        $(parent).style.width=parentW+"px";
        $(parent).style.margin="0 auto";

        var arrHeight=[];
        for(var i=0;i<allBox.length;i++){
            var boxHeight=allBox[i].offsetHeight;
            if(i<cols){
                arrHeight.push(boxHeight);
            }else {
                var minBoxHeight_Short= _.min(arrHeight);
                var minBoxHeight_ShortIndex=getMinIndex(arrHeight,minBoxHeight_Short);

                allBox[i].style.position="absolute";
                allBox[i].style.left=boxWidth*minBoxHeight_ShortIndex+"px";
                allBox[i].style.top=minBoxHeight_Short+"px";

                arrHeight[minBoxHeight_ShortIndex]+=boxHeight;

            }
        }
    }
    function getMinIndex(arr,value){
        for(var i=0;i<arr.length;i++){
            if(arr[i]==value){
                return i ;
            }
        }
    }

    function isWillLoadBox(){
        var allBox=$("main").getElementsByClassName("box");

        var lastBox=allBox[allBox.length-1];
        var lastBoxHeight=lastBox.offsetHeight*0.5;

        var lastBoxOffsetTop=lastBox.offsetTop;

        var sreenH=document.documentElement.clientHeight||document.body.clientHeight;

        var myscrollTop=scroll().top;

        var leftBox=lastBoxHeight+lastBoxOffsetTop;
        var rightBox=sreenH+myscrollTop;

        return leftBox<rightBox;

    }
</script>
</body>
</html>